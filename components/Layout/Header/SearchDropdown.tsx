import React, { useState, useRef, useEffect, useMemo } from 'react';
import { createPortal } from 'react-dom';
import { useNavigate } from 'react-router-dom';
import { Search, FileText, AlertTriangle, Settings } from 'lucide-react';
import { cn } from '../../ui/utils';
import { NAV_CONFIG } from '../../../constants';
import { NavItem } from '../../../types';

interface SearchDropdownProps {
  className?: string;
}

export const SearchDropdown: React.FC<SearchDropdownProps> = ({ className }) => {
  const navigate = useNavigate();
  const [isSearchFocused, setIsSearchFocused] = useState(false);
  const [searchQuery, setSearchQuery] = useState("");
  const searchInputRef = useRef<HTMLInputElement>(null);
  const searchContainerRef = useRef<HTMLDivElement>(null);
  const searchDropdownRef = useRef<HTMLDivElement>(null);

  // Flatten navigation items for search
  const flattenNavItems = (items: NavItem[], parentLabel?: string): Array<NavItem & { fullPath?: string }> => {
    let result: Array<NavItem & { fullPath?: string }> = [];
    items.forEach(item => {
      const fullLabel = parentLabel ? `${parentLabel} > ${item.label}` : item.label;
      if (item.path) {
        result.push({ ...item, fullPath: fullLabel });
      }
      if (item.children) {
        result = result.concat(flattenNavItems(item.children, fullLabel));
      }
    });
    return result;
  };

  const allNavItems = useMemo(() => flattenNavItems(NAV_CONFIG), []);

  // Filter navigation items based on search query
  const filteredNavItems = useMemo(() => {
    if (!searchQuery.trim()) return [];
    return allNavItems.filter(item =>
      item.label.toLowerCase().includes(searchQuery.toLowerCase()) ||
      (item.fullPath && item.fullPath.toLowerCase().includes(searchQuery.toLowerCase()))
    ).slice(0, 5);
  }, [searchQuery, allNavItems]);

  // Keyboard shortcut for search
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        searchInputRef.current?.focus();
      }
      // Close search dropdown with Escape
      if (e.key === 'Escape' && isSearchFocused) {
        setIsSearchFocused(false);
        searchInputRef.current?.blur();
      }
      // Search all results with Enter
      if (e.key === 'Enter' && isSearchFocused && searchQuery.trim()) {
        handleSearchAll();
      }
    };
    document.addEventListener('keydown', handleKeyDown);
    return () => document.removeEventListener('keydown', handleKeyDown);
  }, [isSearchFocused, searchQuery]);

  // Close search dropdown when clicking outside
  useEffect(() => {
    if (!isSearchFocused) return;
    const handleClick = (e: MouseEvent) => {
      const target = e.target as Node;
      // Check if click is outside both the search container AND the dropdown
      if (searchContainerRef.current && !searchContainerRef.current.contains(target) &&
          searchDropdownRef.current && !searchDropdownRef.current.contains(target)) {
        setIsSearchFocused(false);
      }
    };
    document.addEventListener('mousedown', handleClick);
    return () => document.removeEventListener('mousedown', handleClick);
  }, [isSearchFocused]);

  const handleSearchAll = () => {
    console.log("Search all results for:", searchQuery);
    setIsSearchFocused(false);
    // TODO: Navigate to search results page or trigger global search
  };

  const handleRecentItemClick = (item: string) => {
    console.log("Navigate to:", item);
    setIsSearchFocused(false);
    setSearchQuery("");
    // TODO: Navigate to specific document/deviation
  };

  const handleNavItemClick = (path: string) => {
    navigate(path);
    setIsSearchFocused(false);
    setSearchQuery("");
  };

  return (
    <>
      {/* Overlay */}
      {isSearchFocused && createPortal(
        <div 
          className="fixed inset-0 z-50"
          onClick={() => setIsSearchFocused(false)}
        />,
        document.body
      )}

      <div ref={searchContainerRef} className={cn("w-full max-w-xl lg:max-w-2xl relative", className)}>
        {/* Input Wrapper */}
        <div className="relative group">
          <div className="absolute inset-y-0 left-0 pl-3 md:pl-3.5 flex items-center pointer-events-none">
            <Search className={cn(
              "h-4 w-4 md:h-5 md:w-5 transition-colors duration-200", 
              isSearchFocused ? "text-emerald-600" : "text-slate-400"
            )} />
          </div>
          <input
            ref={searchInputRef}
            type="text"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className={cn(
              "block w-full pl-10 md:pl-11 pr-12 md:pr-16 py-2 md:py-2.5 rounded-lg border leading-5 transition-all duration-200",
              "text-sm md:text-[15px]",
              "placeholder-slate-400 focus:outline-none",
              isSearchFocused 
                ? "bg-white ring-2 ring-emerald-500/50 border-emerald-500 shadow-lg shadow-emerald-500/5" 
                : "bg-slate-50 border-slate-200 hover:bg-white hover:border-slate-300 text-slate-700"
            )}
            placeholder="Search documents, deviations, tasks..."
            onFocus={() => setIsSearchFocused(true)}
          />
        </div>

        {/* Quick Results Dropdown */}
        {isSearchFocused && createPortal(
          <div 
            ref={searchDropdownRef}
            className="fixed bg-white rounded-lg shadow-2xl border border-slate-200 overflow-hidden animate-in fade-in slide-in-from-top-2 duration-200 z-[100]"
            style={{
              top: `${searchContainerRef.current?.getBoundingClientRect().bottom! + window.scrollY + 8}px`,
              left: `${searchContainerRef.current?.getBoundingClientRect().left! + window.scrollX}px`,
              width: `${searchContainerRef.current?.getBoundingClientRect().width}px`
            }}
          >
            {searchQuery.trim() ? (
              // Search Results
              <div className="max-h-[400px] overflow-y-auto">
                <div className="p-2">
                  <div className="px-3 py-2 text-xs font-semibold text-slate-500 uppercase tracking-wider">
                    Search Results for "{searchQuery}"
                  </div>
                  <button 
                    onClick={() => handleRecentItemClick("SOP-QA-001")}
                    className="w-full flex items-center gap-3 px-3 py-2.5 text-sm text-slate-700 hover:bg-slate-50 rounded-md transition-colors text-left group"
                  >
                    <div className="h-8 w-8 rounded-md bg-blue-50 flex items-center justify-center shrink-0 group-hover:bg-blue-100 transition-colors">
                      <FileText className="h-4 w-4 text-blue-600" />
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="font-medium text-slate-900 truncate">SOP-QA-001</p>
                      <p className="text-xs text-slate-500 truncate">Batch Release Procedure</p>
                    </div>
                  </button>
                  <button 
                    onClick={() => handleRecentItemClick("SOP-QA-005")}
                    className="w-full flex items-center gap-3 px-3 py-2.5 text-sm text-slate-700 hover:bg-slate-50 rounded-md transition-colors text-left group"
                  >
                    <div className="h-8 w-8 rounded-md bg-emerald-50 flex items-center justify-center shrink-0 group-hover:bg-emerald-100 transition-colors">
                      <FileText className="h-4 w-4 text-emerald-600" />
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="font-medium text-slate-900 truncate">SOP-QA-005</p>
                      <p className="text-xs text-slate-500 truncate">Quality Control Testing</p>
                    </div>
                  </button>
                  <button 
                    onClick={() => handleRecentItemClick("DEV-2023-089")}
                    className="w-full flex items-center gap-3 px-3 py-2.5 text-sm text-slate-700 hover:bg-slate-50 rounded-md transition-colors text-left group"
                  >
                    <div className="h-8 w-8 rounded-md bg-red-50 flex items-center justify-center shrink-0 group-hover:bg-red-100 transition-colors">
                      <AlertTriangle className="h-4 w-4 text-red-600" />
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="font-medium text-slate-900 truncate">DEV-2023-089</p>
                      <p className="text-xs text-slate-500 truncate">Temperature Excursion Room 4</p>
                    </div>
                  </button>
                  
                  {/* Navigation Items Section */}
                  {filteredNavItems.length > 0 && (
                    <>
                      <div className="px-3 py-2 mt-1 text-xs font-semibold text-slate-500 uppercase tracking-wider border-t border-slate-100">
                        Pages & Features
                      </div>
                      {filteredNavItems.map((navItem) => {
                        const Icon = navItem.icon;
                        return (
                          <button
                            key={navItem.id}
                            onClick={() => handleNavItemClick(navItem.path!)}
                            className="w-full flex items-center gap-3 px-3 py-2.5 text-sm text-slate-700 hover:bg-slate-50 rounded-md transition-colors text-left group"
                          >
                            <div className="h-8 w-8 rounded-md bg-emerald-50 flex items-center justify-center shrink-0 group-hover:bg-emerald-100 transition-colors">
                              {Icon && <Icon className="h-4 w-4 text-emerald-600" />}
                            </div>
                            <div className="flex-1 min-w-0">
                              <p className="font-medium text-slate-900 truncate">{navItem.label}</p>
                              {navItem.fullPath && navItem.fullPath !== navItem.label && (
                                <p className="text-xs text-slate-500 truncate">{navItem.fullPath}</p>
                              )}
                            </div>
                          </button>
                        );
                      })}
                    </>
                  )}
                </div>
              </div>
            ) : (
              // Recent Items
              <div className="p-2">
                <div className="px-3 py-2 text-xs font-semibold text-slate-500 uppercase tracking-wider">
                  Recent
                </div>
                <button 
                  onClick={() => handleRecentItemClick("SOP-QA-001")}
                  className="w-full flex items-center gap-3 px-3 py-2.5 text-sm text-slate-700 hover:bg-slate-50 rounded-md transition-colors text-left group"
                >
                  <div className="h-8 w-8 rounded-md bg-blue-50 flex items-center justify-center shrink-0 group-hover:bg-blue-100 transition-colors">
                    <FileText className="h-4 w-4 text-blue-600" />
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="font-medium text-slate-900 truncate">SOP-QA-001</p>
                    <p className="text-xs text-slate-500 truncate">Batch Release Procedure</p>
                  </div>
                </button>
                <button 
                  onClick={() => handleRecentItemClick("DEV-2023-089")}
                  className="w-full flex items-center gap-3 px-3 py-2.5 text-sm text-slate-700 hover:bg-slate-50 rounded-md transition-colors text-left group"
                >
                  <div className="h-8 w-8 rounded-md bg-red-50 flex items-center justify-center shrink-0 group-hover:bg-red-100 transition-colors">
                    <AlertTriangle className="h-4 w-4 text-red-600" />
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="font-medium text-slate-900 truncate">DEV-2023-089</p>
                    <p className="text-xs text-slate-500 truncate">Temperature Excursion Room 4</p>
                  </div>
                </button>
                
                <div className="px-3 py-2 mt-1 text-xs font-semibold text-slate-500 uppercase tracking-wider border-t border-slate-100">
                  Quick Actions
                </div>
                <button 
                  onClick={() => {
                    console.log("Navigate to System Configuration");
                    setIsSearchFocused(false);
                  }}
                  className="w-full flex items-center gap-3 px-3 py-2.5 text-sm text-slate-700 hover:bg-slate-50 rounded-md transition-colors text-left group"
                >
                  <Settings className="h-4 w-4 text-slate-400 ml-2 group-hover:text-slate-600 transition-colors" />
                  <span>System Configuration</span>
                </button>
              </div>
            )}
          </div>,
          document.body
        )}
      </div>
    </>
  );
};
